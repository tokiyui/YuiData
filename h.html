<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>セットリスト</title>
<style>
table {
  border-collapse: collapse;
  width: 100%;
}

table, th, td {
  border: 1px solid black;
}

th, td {
  padding: 8px;
  text-align: left;
}

th {
  background-color: #f2f2f2;
}

/* Pink background color for cells with different content */
tr.diff-content td {
  background-color: pink;
}
</style>
</head>
<body>

<select id="concertSelector">
  <option value="HAPPY JAM">小倉唯 1st LIVE「HAPPY JAM」</option>
  <option value="High-Touch☆Summer">小倉唯 1st LIVE TOUR「High-Touch☆Summer」</option>
  <option value="Smiley Cherry">小倉唯 LIVE「Smiley Cherry」</option>
  <option value="Platinum Airline☆">小倉唯 2nd LIVE TOUR「Platinum Airline☆」</option>
  <option value="Step Apple">小倉唯 LIVE TOUR 2019「Step Apple」</option>
  <option value="#Re♥LOVEcall">小倉唯 LIVE 2021「#Re♥LOVEcall」</option>
  <option value="Memorial LIVE 2023 ~To the 11'Eleven~">小倉唯 Memorial LIVE 2023 ~To the 11'Eleven~</option>
  <option value="Memorial LIVE 2023 ~10th Anniversary Assemble!!~">小倉唯 Memorial LIVE 2023 ~10th Anniversary Assemble!!~</option>
  <option value="KING SUPER LIVE">KING SUPER LIVE</option>
  <option value="Animelo Summer Live">Animelo Summer Live</option>
  <option value="ANIMAX MUSIX">ANIMAX MUSIX</option>
</select>

<table id="setlistTable">
  <thead>
    <tr>
      <th>曲目</th>
      <th>日付</th>
      <th>タイトル</th>
      <th>会場</th>
      <th>セットリスト</th>
    </tr>
  </thead>
  <tbody id="setlistBody"></tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const concertSelector = document.getElementById('concertSelector');
    const setlistTableBody = document.getElementById('setlistBody');

    concertSelector.addEventListener('change', function() {
        const selectedConcert = this.value;
        fetchAndDisplaySetlist(selectedConcert);
    });

    function fetchAndDisplaySetlist(selectedConcert) {
        fetchSetlist(selectedConcert)
            .then(setlistData => {
                const formattedSetlist = formatSetlist(setlistData);
                displaySetlist(formattedSetlist);
            })
            .catch(error => {
                console.error('Error fetching or displaying setlist:', error);
                setlistTableBody.innerHTML = '<tr><td colspan="5">Error fetching or displaying setlist. Please try again later.</td></tr>';
            });
    }

    function fetchSetlist(selectedConcert) {
        return fetch(`https://api.github.com/repos/tokiyui/YuiData/contents/setlist`)
            .then(response => response.json())
            .then(files => {
                const setlistPromises = files.map(file => {
                    if (file.type === 'file' && file.name.endsWith('.txt')) {
                        return fetch(`setlist/${file.name}`)
                            .then(response => response.text())
                            .then(data => {
                                if (data.includes(selectedConcert)) {
                                    return data;
                                } else {
                                    return null;
                                }
                            });
                    }
                });
                return Promise.all(setlistPromises)
                    .then(setlists => setlists.filter(setlist => setlist !== null));
            });
    }

    function formatSetlist(setlistData) {
        const formattedSetlist = [];
        let songCount = 0;
        let medleyCount = 0;
        let encoreStarted = false;
        let encoreCount = 0;

        setlistData.forEach(setlist => {
            const lines = setlist.split('\n');
            const date = lines[0].trim();
            const title = lines[1].trim();
            const venue = lines[2].trim();
            const songs = lines.slice(3).map(line => line.trim()).filter(line => line !== '');

            songs.forEach((song, index) => {
                const rowData = {
                    date: index === 0 ? date : '',
                    title: index === 0 ? title : '',
                    venue: index === 0 ? venue : '',
                    songNumber: index === 0 ? ++songCount : '',
                    isDifferentContent: index !== 0 && song !== songs[index - 1],
                    isMedley: song === '<MEDLEY>',
                    isEncore: song === '<ENCORE>',
                    isDoubleEncore: song === '<W ENCORE>',
                    isFanClub: song === '<FAN CLUB>',
                    songName: song
                };

                if (rowData.isMedley) {
                    medleyCount++;
                    rowData.songNumber = songCount + medleyCount;
                } else if (rowData.isEncore) {
                    encoreStarted = true;
                    encoreCount = 0;
                } else if (rowData.isDoubleEncore) {
                    rowData.date = '';
                    rowData.title = '';
                    rowData.venue = '';
                    encoreStarted = false;
                } else if (rowData.isFanClub) {
                    encoreStarted = false;
                } else if (encoreStarted) {
                    rowData.songNumber = 'EC' + ++encoreCount;
                }

                formattedSetlist.push(rowData);
            });
        });

        return formattedSetlist;
    }

    function displaySetlist(setlist) {
        setlistTableBody.innerHTML = '';

        setlist.forEach(rowData => {
            const row = document.createElement('tr');

            const cellNumber = document.createElement('td');
            cellNumber.textContent = rowData.songNumber;
            row.appendChild(cellNumber);

            const cellDate = document.createElement('td');
            cellDate.textContent = rowData.date;
            row.appendChild(cellDate);

            const cellTitle = document.createElement('td');
            cellTitle.textContent = rowData.title;
            row.appendChild(cellTitle);

            const cellVenue = document.createElement('td');
            cellVenue.textContent = rowData.venue;
            row.appendChild(cellVenue);

            const cellSong = document.createElement('td');
            cellSong.innerHTML = rowData.isMedley ? `【メドレーコーナー】` : `<a href="search.html?name=${encodeURIComponent(rowData.songName)}">${rowData.songName}</a>`;
            row.appendChild(cellSong);

            if (rowData.isDifferentContent) {
                row.classList.add('diff-content');
            }

            setlistTableBody.appendChild(row);
        });
    }
});
</script>

</body>
</html>
