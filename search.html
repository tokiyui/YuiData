<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setlist Search Debug</title>
</head>
<body>
    <h1>Setlist Search Debug</h1>
    <div id="results"></div>

    <script>
        // 検索文字列を取得する関数
        function getQueryStringValue(key) {
            return decodeURIComponent(window.location.search.replace(new RegExp(`^(?:.*[&\\?]${encodeURIComponent(key).replace(/[\\?&]$/, '')}(?:\\=([^&]*))?)?.*$`, 'i'), '$1'));
        }

        // 検索文字列を取得
        const query = getQueryStringValue('name');
        console.log('Search query:', query);

        // 検索関数
        function search(query) {
            console.log('Searching for:', query);
            const setlistDirectory = 'setlist'; // ディレクトリのパスを指定

            fetchSetlistFiles(setlistDirectory)
                .then(files => {
                    console.log('Files:', files);
                    return searchFiles(files, query);
                })
                .then(results => {
                    console.log('Search results:', results);
                    displayResults(results);
                })
                .catch(error => console.error('Error:', error));
        }

        // ディレクトリ内のファイルを取得する関数
        function fetchSetlistFiles(directory) {
            const url = `https://api.github.com/repos/tokiyui/YuiData/contents/${directory}`;
            console.log('Fetching files from:', url);
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    const files = data.filter(item => item.type === 'file').map(item => item.name);
                    console.log('Fetched files:', files);
                    return files;
                });
        }

        // ファイル内を検索する関数
        function searchFiles(files, query) {
            const promises = files.map(file => {
                const url = `setlist/${file}`;
                console.log('Searching in file:', url);
                return fetch(url)
                    .then(response => response.text())
                    .then(text => {
                        console.log('File content:', text);
                        const lines = text.split('\n');
                        const match = lines.find(line => line.toLowerCase().includes(query));
                        if (match) {
                            return { filename: file, line1: lines[0], line2: lines[1] };
                        }
                    });
            });
            return Promise.all(promises).then(results => results.filter(Boolean));
        }

        // 検索結果を表示する関数
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p>No results found.</p>';
            } else {
                results.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.innerHTML = `<p><strong>${result.filename}</strong><br>Line 1: ${result.line1}<br>Line 2: ${result.line2}</p>`;
                    resultsDiv.appendChild(resultDiv);
                });
            }
        }

        // 検索を実行
        search(query);
    </script>
</body>
</html>
