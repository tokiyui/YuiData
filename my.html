<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Checker</title>
</head>
<body>
    <h1>Song Checker</h1>
    <form id="songCheckerForm">
        <fieldset>
            <legend>Choose Setlists</legend>
            <div id="setlistCheckboxes">
                <!-- Setlist checkboxes will be populated here -->
            </div>
        </fieldset>
        <button type="button" onclick="searchSongs()">Search Songs</button>
    </form>
    <div id="searchResults">
        <!-- Search results will be displayed here -->
    </div>

    <script>
        async function fetchSetlists() {
            const response = await fetch('https://api.github.com/repos/tokiyui/YuiData/contents/setlist');
            const data = await response.json();
            return data;
        }

        async function fetchFileContent(path) {
            const response = await fetch(`https://api.github.com/repos/tokiyui/YuiData/contents/${path}`);
            const data = await response.json();
            const content = atob(data.content); // Decode base64 content
            return content;
        }

        async function searchSongs() {
            const setlistCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const setlists = await fetchSetlists();
            const searchResults = document.getElementById('searchResults');

            if (setlistCheckboxes.length === 0) {
                searchResults.innerHTML = '<p>Please select at least one setlist.</p>';
                return;
            }

            const setlistPaths = Array.from(setlistCheckboxes).map(checkbox => checkbox.value);

            const results = [];
            for (const setlistPath of setlistPaths) {
                const setlistContent = await fetchFileContent(setlistPath);
                const setlistLines = setlistContent.split('\n');
                const songFile = setlistLines[1].trim();

                if (!songFile.endsWith('.txt')) {
                    results.push(`<p>Invalid song file path in ${setlistPath}.</p>`);
                    continue;
                }

                const songContent = await fetchFileContent(`setlist/${songFile}`);
                const songLines = songContent.split('\n');

                for (const line of songLines) {
                    const [songName] = line.split(',');
                    const found = setlistLines.some(setlistLine => setlistLine.trim().startsWith(songName.trim()));
                    results.push(`<p>${songName}: ${found ? 'Exists' : 'Not Found'}</p>`);
                }
            }

            searchResults.innerHTML = results.join('');
        }

        async function populateSetlistCheckboxes() {
            const setlists = await fetchSetlists();
            const setlistCheckboxes = document.getElementById('setlistCheckboxes');

            setlists.forEach(setlist => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = setlist.path;
                checkbox.id = setlist.name;
                const label = document.createElement('label');
                label.htmlFor = setlist.name;
                label.textContent = setlist.name;
                const br = document.createElement('br');
                setlistCheckboxes.appendChild(checkbox);
                setlistCheckboxes.appendChild(label);
                setlistCheckboxes.appendChild(br);
            });
        }

        populateSetlistCheckboxes();
    </script>
</body>
</html>
