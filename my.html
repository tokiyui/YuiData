<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Setlist Checker</title>
</head>
<body>
<h1>Setlist Checker</h1>
<div id="checkboxes"></div>
<button id="searchButton">検索</button>
<div id="searchResults"></div>

<script>
// GitHub APIのベースURL
const baseUrl = 'https://api.github.com/repos/';

// リポジトリ情報
const owner = 'tokiyui'; // リポジトリの所有者名
const repo = 'YuiData'; // リポジトリ名
const path = 'setlist/'; // チェックするファイルが含まれているディレクトリパス

// GitHub APIを使用して指定されたパスのファイルを取得する関数
async function getFiles(path) {
  const url = `${baseUrl}${owner}/${repo}/contents/${path}`;
  const response = await fetch(url);
  const data = await response.json();
  return data;
}

// チェックボックスとしてファイルを表示する関数
async function displayCheckboxes() {
  const files = await getFiles(path);
  const checkboxesDiv = document.getElementById('checkboxes');
  for (const file of files) {
    if (file.type === 'file' && file.name.endsWith('.txt')) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'fileCheckbox';
      checkbox.value = file.download_url;
      checkboxesDiv.appendChild(checkbox);
      const label = document.createElement('label');
      label.htmlFor = 'fileCheckbox';
      label.appendChild(document.createTextNode(file.name));
      checkboxesDiv.appendChild(label);
      checkboxesDiv.appendChild(document.createElement('br'));
    }
  }
}

// 楽曲名で検索を行う関数
async function search() {
  const checkboxes = document.querySelectorAll('input[name="fileCheckbox"]:checked');
  const searchResultsDiv = document.getElementById('searchResults');
  searchResultsDiv.innerHTML = ''; // 検索結果をリセット
  const songResponse = await fetch(`${baseUrl}${owner}/${repo}/contents/song.txt`);
  const songText = await songResponse.text();
  const songLines = songText.split('\n');

  checkboxes.forEach(async checkbox => {
    const fileResponse = await fetch(checkbox.value);
    const fileText = await fileResponse.text();
    const fileName = checkbox.nextSibling.textContent.trim();
    
    const foundSongs = songLines.filter(songLine => {
      const songTitle = songLine.split(',')[0].trim();
      return fileText.includes(songTitle);
    });

    foundSongs.forEach(foundSong => {
      const songTitle = foundSong.split(',')[0].trim();
      const resultDiv = document.createElement('div');
      resultDiv.textContent = `${songTitle}: あり (${fileName})`;
      searchResultsDiv.appendChild(resultDiv);
    });

  });

  // 検索結果がない場合
  const notFoundSongs = songLines.filter(songLine => {
    const songTitle = songLine.split(',')[0].trim();
    return !checkboxes.some(checkbox => {
      const fileText = checkbox.nextSibling.textContent.trim();
      return fileText.includes(songTitle);
    });
  });

  notFoundSongs.forEach(notFoundSong => {
    const songTitle = notFoundSong.split(',')[0].trim();
    const resultDiv = document.createElement('div');
    resultDiv.textContent = `${songTitle}: なし`;
    searchResultsDiv.appendChild(resultDiv);
  });

}

// ページが読み込まれた時に呼び出す関数
window.onload = function() {
  displayCheckboxes();
  document.getElementById('searchButton').addEventListener('click', search);
};
</script>
</body>
</html>
